<!DOCTYPE html>
<html>

<head>
  <title>PokeMaps</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
    crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
    crossorigin="anonymous"></script>
  
  <link href="https://fonts.googleapis.com/css?family=Cormorant+Unicase" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
  <link href="assets/fonts/font.ttf">
  <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>

  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyB5Ugq8rh8gFP6SMX38Nx4_5-3YtYuJnCY",
      authDomain: "pokemastersunite-1531512209090.firebaseapp.com",
      databaseURL: "https://pokemastersunite-1531512209090.firebaseio.com",
      projectId: "pokemastersunite-1531512209090",
      storageBucket: "pokemastersunite-1531512209090.appspot.com",
      messagingSenderId: "871367348175"
    };
    firebase.initializeApp(config);
  </script>


  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

    #map {
      border-style: solid;
      border-width: 3px;
      border-color: red;
      border-radius: 35px;
    }


    /* Optional: Makes the sample page fill the window. */

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;

    }

    body {
      /* font-family: 'Cormorant Unicase', serif; */
      font-weight: strong;
      font-family: PokemonFont;
    }


    @font-face {
      font-family: PokemonFont;
      src: url("assets/fonts/font.ttf");
    }

    button{
      background:white;
      color:red;
      border-style: solid;
      border-color: red;
      border-radius: 20px;
    }
    button:hover{
      background:rgb(255, 204, 37);
      color:blue;
      border-style: solid;
      border-color: blue;
    } 
  </style>
</head>

<body>
<div class="container">
<div class="row">
  <div class="col-md-12" style="border-style:solid;border-width:3px;border-color: red;border-radius: 35px;width:80%;">
    <img src="https://logos-download.com/wp-content/uploads/2016/07/Pok%C3%A9mon_logo.png" style="max-width: 250px;height:auto; padding:10px;">    
      <input class="introDiv"type="text" id="trainerName" style="width:15% ;border-radius: 20px;float:right;margin-top:45px;margin-right:15px" placeholder="name">
      <button class="introDiv"style="float:right; margin-top:45px;margin-right:10px;margin-bottom:10px;margin-left:10px" id="searchPlayers">Go Online</button>
    <p style="float: right;margin-top:50px;"  id="groot"></p>
  </div>

</div>

  <div class="row" style="min-height:500px;">
    <div id="map" style="min-height:500px;padding:10px;" class="col-md-6 mx-4 my-4">
     <!-- ---------------------- -->
    </div>

    

    <div id="msgBox"  class="col-md-5 mx-4 my-4"style="padding:10px;border-style:solid;border-width:3px;border-color: red;max-height:250px;border-radius:35px;">
      <div class="container" style="overflow:auto;height:100%;max-width:90%">
        <table class="table table-hover table-bordered" style="border-style: solid;border-color:blue;border-radius: 35px;width:100% ;margin:auto;" id="plyerTable">
          <thead>
            <tr style="width:100%;">
              <!-- <th scope='row'></th> -->
              <th style="text-align:center">Players Online</th>
            </tr>
          </thead>
          <tbody id="tableBody">
  
          </tbody>
        </table>
      </div>
      
  
        <div id="placeMsg"class="row my-5"style="overflow:auto;min-height:100%;max-height:220px;background-color:lightgray;border-style:dashed;border-color: blue;border-radius: 35px;">
          <div style="max-width: 90%;min-width: 85%;max-height: 100%">  
          <table class="table" style="max-width:90;margin-bottom: auto;" id="msgTable">
                <thead>
                  <tr style="width:100%;">
                    <!-- <th scope='row'></th> -->
                    <th style="text-align:center">Message Center</th>
                  </tr>
                </thead>
                <tbody id="tableBudy">
        
                </tbody>
              </table>
            </div>
            <div style="text-align:center;position: fixed;bottom :70px;">
              <input id="messageHtml"class="ml-4"type="text" style="width:75% ;border-radius:20px;">
              <button id="sendMessageBtn">GO!</button>
            </div>
          </div>

  </div>
   
  </div>

</div>
  <script>

    //////////////////////////////////////////////////////////////////////////////
    /////     vars below                       ////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////
    var presenceRef;
    var currentPlayer;
    var timesLoop;
    var newPosition;
    var newName;
    var map;
    var amtTraining;
    var iconBase = 'https://cdn.iconscout.com/public/images/icon/premium/png-128/location-pokemon-pokeball-3476aca8ecd2f053-128x128.png';

    //////////////////////////////////////////////////////////////////////////////
    /////   set up the database to have a reference of the number of players   ////////
    //////////////////////////////////////////////////////////////////////////////
    firebase.database().ref("trainersOnline/" + "numOfTrainer").on("value", function (snapshot) {
              var getIt = snapshot.val();
              amtTraining = getIt;
              if(amtTraining === null){
                amtTraining = 0;
                firebase.database().ref().child("trainersOnline").set({
                numOfTrainer: amtTraining
              });
              }
    });

    $("#placeMsg").hide();


////////////////////////////////////////////////////////////////////////////////////////
////////////// initiate the map ////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 6
      });
    
      //////////////////////////////////////////////////////////////////////
      ////////////////              click event         /////////////////////////
      /////////////////////////////////////////////////////////////////////////
      $("#searchPlayers").on("click", function () {
        trainerNamez = $("#trainerName").val();

        if(trainerNamez === "CLEAR-DATABASE-RIGHT-NOW" ){
          firebase.database().ref().set("");
        }
        if(trainerNamez !== "" && trainerNamez.length < 18){
          localStorage.setItem("Trainer Name=",trainerNamez);
          $("#groot").text("Welcome to PokeGoMaps "+trainerNamez+"!");
          $(".introDiv").remove();
          $("#placeMsg").show();
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,

            };
            database = firebase.database();

            database.ref("trainersOnline/" + "numOfTrainer").on("value", function (snapshot) {
              amtTraining = snapshot.val();

            });

            amtTraining++;
            database.ref().child("trainersOnline").set({
              numOfTrainer: amtTraining
            });

            console.log(database.ref().child("Trainers " + amtTraining));

          

            database.ref().child("Trainers " + amtTraining).set({
              name: trainerNamez,
              position: pos
            });

            localStorage.setItem("Trainer", amtTraining);
            currentPlayer = amtTraining;
            
            console.log(amtTraining);

            var marker = new google.maps.Marker({
              position: pos,
              icon: iconBase,
              map: map
            });
            map.setZoom(13);
            map.setCenter(marker.getPosition());
            //infoWindow.open(map);
            map.setCenter(pos);
          }, 
          function () {
            handleLocationError(true, new google.maps.InfoWindow("failed to launch!"), map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, new google.maps.InfoWindow("failed to launch!"), map.getCenter());
        }
        
      

      //////////////////////////////////////////////////////////////////////
      ///////////////////  pull people from database and place on map///////
      /////////////////////////////////////////////////////////////////////
     
    $("#tableBody").html("");     
    $(document).ready(function () {
      firebase.database().ref("trainersOnline/" + "numOfTrainer").on("value", function (snapshot) {
        timesLoop = snapshot.val();
        //console.log(timesLoop);
      });

      for (var i = 1; i <= timesLoop; i++) {
       // console.log("hi " + i);
        firebase.database().ref("Trainers " + i + "/name").on("value", function (snapshot) {
         // console.log(JSON.stringify(snapshot.val()));
          newName = JSON.stringify(snapshot.val());
          $('#tableBody').append("<tr><td onclick='sendInvite(this);'class='trainMe'style='text-align:center'>"+newName+"</td></tr>");
        });
        
        var newLat;
        var newLng;
        var newLatTmp;
        var newLngTmp;

        firebase.database().ref("Trainers " + i + "/position/lat").on("value", function (snapshot) {
          //console.log("Latitude: " + JSON.stringify(snapshot.val()));
          newLat = parseFloat(snapshot.val());
         // console.log(newLat);

        });

        firebase.database().ref("Trainers " + i + "/position/lng").on("value", function (snapshot) {
          //console.log("Longitute " + JSON.stringify(snapshot.val()));
          newLngTmp = parseFloat(snapshot.val());
          //console.log(newLngTmp);

          
          if(newLngTmp === newLng){
            newLng = newLngTmp + 0.005;
            //console.log(newLng+ " if");
          }
          else{
            newLng = newLngTmp;
            //console.log(newLng + " else");
          }
          //newLng = newLngTmp;
          
            newPosition = {lat: newLat, lng: newLng,};

            var marker = new google.maps.Marker({
              position: newPosition,
              icon: iconBase,
              map: map

            });
            map.setZoom(13);
            map.setCenter(marker.getPosition());
            //infoWindow.open(map);
            map.setCenter(newPosition);
            
        
        
        });

    
        
            
      }

    });
        }
        else{
          alert("Please enter your trainer name below. Your trainer name must not contain more than 18 characters.");
        }
  });

      ///////////////////////////////////////////////////////////////////////////
      //// in the eventuality that the user does not grant access for location....
      ////////////////////////////////////////////////////////////////////////////////////

    infoWinow = new google.maps.InfoWindow();
    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }
  
}


////////////////////////////////////////////////////////////////////////
///////////// Send invites to other players //////////////////////////////
////////////////////////////////////////////////////////////////////////

function sendInvite(elementz){
    console.log(elementz.innerText);
    elementz.style.backgroundColor="blue";
    

}


//////////////////////////////////////////////////////////////////////
/////// removes data from storage when oage is disconnected /////////////
//////////////////////////////////////////////////////////////////////

var tempLocStorage = (parseInt(localStorage.getItem("Trainer"))+1);

presenceRef = firebase.database().ref("Trainers "+tempLocStorage);
// Write a string when this client loses connection
presenceRef.onDisconnect().remove();

/////////////////////////////////////////////////////////////
///////////// Buttton to send message ///////////////////////
//////////////////////////////////////////////////////////

$("#sendMessageBtn").on("click", function(){
  var message = $("#messageHtml").val();
  var myName = localStorage.getItem("Trainer Name=");
  console.log(message);
  if(message.length < 200){
    $('#tableBudy').append("<tr><td style='max-width:450px;font-size: 8px;text-align:left'><div style='max-width:70%;'><p>"+myName+" wrote:</p></div></td></tr>");
    $('#tableBudy').append("<tr><td style='max-width:450px;font-size: 8px;text-align:left'><div style='max-width:70%;margin-left:30px;'><p>"+message+"</p></div></td></tr>");
  }
  else{
    alert("Message are not meant to be long here! Max length = 200");
  }

});


  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJJwQTT1bzDxMzFNWgdR4KUwgDDekLogw&callback=initMap">
  </script>
</body>

</html>